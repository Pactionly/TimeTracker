<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Calendar Example</title>
  <link rel="stylesheet" href="">
</head>

<body>
      <div class="top-bar" style="color:#FFFFFF; background-color:#000000">
        <div class="top-bar-left" style="color:#FFFFFF; background-color:#000000">
          <ul class="dropdown menu" data-dropdown-menu style="color:#FFFFFF; background-color:#000000">
            <li class="menu-text" style="color:#FFFFFF; background-color:#000000">Time Tracker</li>
            <li><a href="/" style="color:#FFFFFF; background-color:#000000">Home</a></li>
            <li><a href="/calendar/" style="color:#FFFFFF; background-color:#000000">Calendar</a></li>
            <li><a href="/timesheet" style="color:#FFFFFF; background-color:#000000">Timesheet</a></li>
          </ul>
        </div>
        <div class="top-bar-right" style="color:#FFFFFF; background-color:#000000">
          <ul class="menu" style="color:#FFFFFF; background-color:#000000">
            
            <li><a href="/login/" class="button expanded">Log In or Register</a></li>
            
          </ul>
        </div>
      </div>
<h1>Example for Google Calendar</h1> 
  <div id="content">
    <p>Fill these fields to enter a new event in your Google Calendar.</p>
    <p><label>Select a date: <input type="date" id="date"></label></p>
    <p><label>Start time <input type="time" id="start"></label>
       <label>End time: <input type="time" id="end"></label>
    </p>
    <p><label>Event description: <input type="text" id="event" size=60></label></p>
    <p><button id="authorize-button" : hidden">Login & Authorize</button></p>
    <p><button id="addToCalendar" style="visibility: hidden">Add to Google Calendar</button></p>
  </div>
    <!--Add a button for the user to click to initiate auth sequence -->
    <script>
      var clientId = '1081502536351-6pojc00bl8ntbe0htg97f8k7b02ieu3g.apps.googleusercontent.com';
      var apiKey = 'AIzaSyDHv1UgXbh5vw2d94ybdQ2Xcg9UJGfgu48';
      var scopes = 'https://www.googleapis.com/auth/calendar';
      
	/* Function invoked when the client javascript library is loaded */
	function handleClientLoad() {
	  console.log("Inside handleClientLoad ...");
	  gapi.client.setApiKey(apiKey);
	  window.setTimeout(checkAuth,100);
	}

	/* API function to check whether the app is authorized. */
	function checkAuth() {
	  console.log("Inside checkAuth ...");
	  gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: true}, 
			      handleAuthResult);
	}

	/* Invoked by different functions to handle the result of authentication checks.*/
	var authData;
	function handleAuthResult(authResult) {
	    console.log("Inside handleAuthResult ...");
	    authData = authResult;
	    var authorizeButton = document.getElementById('authorize-button');
	    var addButton = document.getElementById('addToCalendar');
	    if (authResult && !authResult.error) {
		  authorizeButton.style.visibility = 'hidden';
		  addButton.style.visibility = 'visible'; 
		  //load the calendar client library
		  gapi.client.load('calendar', 'v3', function(){ 
		    console.log("Calendar library loaded.");
		  });
	    } else {
		  authorizeButton.style.visibility = '';
		  authorizeButton.onclick = handleAuthClick;
		}
	}


	/* Event handler that deals with clicking on the Authorize button.*/
	function handleAuthClick(event) {
	    gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: false}, 
				handleAuthResult);
	    return false;
	}

	/* End of PART 1 - Authentication Process. */

	/* Start of PART 2 - dealing with events from the user interface and 
	performing API calls. */


	var addButton = document.getElementById('addToCalendar');
	addButton.onclick = function(){
	  var userChoices = getUserInput();
	  console.log(userChoices);
	  if (userChoices) 
	    createEvent(userChoices);
	}

	function getUserInput(){
	  
	  var date = document.querySelector("#date").value;
	  var startTime = document.querySelector("#start").value;
	  var endTime = document.querySelector("#end").value;
	  var eventDesc = document.querySelector("#event").value;
	  
	  // check input values, they should not be empty
	  if (date=="" || startTime=="" || endTime=="" || eventDesc==""){
	    alert("All your input fields should have a meaningful value.");
	    return
	  }
	  else return {'date': date, 'startTime': startTime, 'endTime': endTime,
		       'eventTitle': eventDesc}
	}


	// Make an API call to create an event.  Give feedback to user.
	function createEvent(eventData) {
	  // First create resource that will be send to server.
	    var resource = {
		"summary": eventData.eventTitle,
		"start": {
		  "dateTime": new Date(eventData.date + " " + eventData.startTime).toISOString()
		},
		"end": {
		  "dateTime": new Date(eventData.date + " " + eventData.endTime).toISOString()
		  }
		};
	    // create the request
	    var request = gapi.client.calendar.events.insert({
	      'calendarId': 'primary',
	      'resource': resource
	    });
	  
	    // execute the request and do something with response
	    request.execute(function(resp) {
	      console.log(resp);
	      alert("Your event was added to the calendar.");
	    });
	}
    </script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
  </body>
</html>
